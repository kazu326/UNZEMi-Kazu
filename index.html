<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>格ゲー読み合いスキル診断シート</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for radar chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Interフォントを適用 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }

        /* カスタムスタイル */
        .container {
            max-width: 800px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            box-sizing: border-box;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
        }

        .slider-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151; /* Dark gray text */
        }

        .slider {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: #d1d5db; /* Light gray track */
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981; /* Green thumb */
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981; /* Green thumb */
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .score-display {
            margin-left: 0.75rem;
            font-weight: 500;
            color: #4b5563; /* Medium gray text */
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #10b981; /* Green */
            color: #ffffff;
            border: none;
        }

        .btn-primary:hover {
            background-color: #059669; /* Darker green */
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #6b7280; /* Gray */
            color: #ffffff;
            border: none;
        }

        .btn-secondary:hover {
            background-color: #4b5563; /* Darker gray */
            transform: translateY(-1px);
        }

        .btn-share {
            background-color: #3b82f6; /* Blue */
            color: #ffffff;
            border: none;
        }

        .btn-share:hover {
            background-color: #2563eb; /* Darker blue */
            transform: translateY(-1px);
        }

        .hidden {
            display: none;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #10b981;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        canvas {
            max-width: 100%; /* Ensure canvas scales on smaller screens */
            height: auto; /* Maintain aspect ratio */
        }

        .select-container {
            margin-bottom: 1.5rem;
        }

        .select-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .select-box {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #ffffff;
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="container">
        <!-- フォーム基本仕様イメージ -->
        <section id="form-section">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">格ゲー読み合いスキル診断シート</h1>
            <p class="text-center text-gray-600 mb-8">
                あなたの“読み合いスキル”を6つの観点で自己評価し、レーダーチャートで強みや課題を可視化するための診断フォームです。<br>
                1試合、または直近の対戦内容をもとに、各項目を**1点（全くできない）〜10点（常にできる）**で自己評価してください。
            </p>

            <div class="space-y-6">
                <!-- 設問項目・具体例（6軸バージョン） -->
                <div class="slider-group">
                    <div class="slider-container">
                        <label for="patternRecognition" class="slider-label">1. パターン認識力
                            <span class="text-sm text-gray-500 block">
                                (相手のクセ・動き・パターンに、何回目の対戦で気づけますか？)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 相手の「飛び」や「突進技」が何度もヒットするまで気づけない。ドライブゲージやスーパーアーツゲージの相手の残量もあまり見ていない。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 相手の「基本的な飛びや投げの癖」には気づくことがあるが、対応が安定しない。ドライブインパクトを返せるようになるが、完璧ではない。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 相手の「セットプレイ」「起き攻めのパターン」「特定の状況での行動選択（例：遅らせグラップ、無敵技の重ね）」を見抜ける場面が増える。相手のゲージ管理を見て、OD技やSAの有無を意識できる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** 相手の微細な行動パターン、意識配分、キャラクター固有のフレーム消費の癖まで素早く認識し、それに応じた完璧な対応や戦略変更ができる。相手の読みの読みまで意識した行動を選択できる。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="patternRecognition" min="1" max="10" value="5" class="slider">
                            <span id="patternRecognitionScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="prediction" class="slider-label">2. 予測力（先読み反応）
                            <span class="text-sm text-gray-500 block">
                                (相手の攻撃・行動をどのくらいの頻度で“先回り”できましたか？ 例：飛び・突進・攻撃タイミングを先読みで刺した回数)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 相手の行動を予測する意識が低く、常に後手になっている。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 読みを試みるが、成功率は低い。読みが当たっても次の行動に繋げられないことがある。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 相手の主要な行動（例：飛び込み、置き技、投げ）を先読みし、有利な反撃や差し返しを成功させられる。モダン操作であればアシストコンボを狙える。</li>
                                    <li>**9-10点 (上級者〜プロ級):** 相手の行動パターンと心理を深く読み解き、複数択の中から最も効果的な先読み行動（例：ドライブインパクト返し、パリィ、投げ抜け、大ダメージコンボ）を高い精度で実行できる。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="prediction" min="1" max="10" value="5" class="slider">
                            <span id="predictionScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="reactionSpeed" class="slider-label">3. 反応速度・最適対応力
                            <span class="text-sm text-gray-500 block">
                                (見てからの差し返しや対空への成功体感率は？)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 相手の確定反撃や対空攻撃をほとんど防げない。咄嗟の状況判断が遅れる。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 半分程度は見てから対応できるが、安定しない。特に画面端や状況が複雑な場面でのミスが多い。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 相手の特定の技や行動（例：ドライブインパクト、ドライブラッシュ、ジャンプ攻撃）を見てからの対応（差し返し、対空、投げ抜け）を高い精度で成功させられる。クラシック操作であれば確定反撃コンボを入れられる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** どんな状況でも相手の行動を見てから最速で最適な反撃や防御行動（例：パニッシュカウンター、大ダメージコンボ、完璧な対空コンボ）を安定して実行できる。入力精度も極めて高い。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="reactionSpeed" min="1" max="10" value="5" class="slider">
                            <span id="reactionSpeedScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="multiLayerReading" class="slider-label">4. 多重読み・心理戦
                            <span class="text-sm text-gray-500 block">
                                (「相手に読まれることを更に読んで駆け引きが出来ましたか？」)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 自分の行動が相手に読まれていることに気づきにくく、同じパターンを繰り返してしまう。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 相手が何をしようとしているかを意識し始めるが、その裏をかく行動はまだ難しい。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 相手が自分の行動をどう読んでいるかを推測し、その裏をかく行動（例：ドライブインパクトのフェイント、投げのシミー、遅らせ投げ、無敵技のガード、ドライブラッシュのキャンセル）を狙って成功させられる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** 相手の心理を深く読み解き、複数回の読み合いを連続で制する高度な心理戦（例：読みの読み、リソース管理、相手のSAゲージ消費を誘う立ち回り）を展開できる。相手を手のひらで転がすような感覚がある。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="multiLayerReading" min="1" max="10" value="5" class="slider">
                            <span id="multiLayerReadingScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="diversityOfOptions" class="slider-label">5. 選択肢の多様性・柔軟性
                            <span class="text-sm text-gray-500 block">
                                (その対戦で使えた選択肢（攻撃/守り/行動）は多かったですか？)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 使える技や戦術が少なく、同じ攻めや守りを繰り返してしまう。キャラの基本技しか使えない。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** ある程度の選択肢は持っているが、状況に合わせた最適な選択ができない。立ち回りがパターン化しやすい。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 状況に応じて豊富な選択肢（例：様々な距離での牽制、崩し、防御オプション、リソース運用）を使い分け、相手の対策を困難にさせられる。キャラの強みを引き出せる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** 自分のキャラクターの全アセットを最大限に活用し、どんな状況でも相手の弱点や行動を潰すための最適な選択肢を柔軟に選び、ゲームを支配できる。キャラ対策も深い。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="diversityOfOptions" min="1" max="10" value="5" class="slider">
                            <span id="diversityOfOptionsScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="mentalResilience" class="slider-label">6. メンタル耐性・動揺度
                            <span class="text-sm text-gray-500 block">
                                (予想外の展開や連続失敗でも落ち着いて判断行動できましたか？)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 予想外のダメージや連続ヒットでパニックになり、冷静な判断ができない。逆ギレ行動や適当な技を振ってしまう。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 不利な状況でも立て直そうとするが、まだ感情に左右されやすい。緊張で入力ミスが増えることがある。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** どんなに不利な状況やミスが続いても、感情的にならず、冷静に状況を判断し、最善の行動（例：防御重視、体力リード時の逃げ切り、ゲージ温存）を選択できる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** プレッシャーのかかる場面や、相手が格上でも常に冷静沈着。ミスを即座に分析し、次のラウンドに活かせる。相手の精神を揺さぶるような行動も意図的にできる。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="mentalResilience" min="1" max="10" value="5" class="slider">
                            <span id="mentalResilienceScore" class="score-display">5点</span>
                        </div>
                    </div>
                </div>

                <!-- AIアドバイスレベル選択 -->
                <div class="select-container">
                    <label for="adviceLevel" class="select-label">AIアドバイスレベル</label>
                    <select id="adviceLevel" class="select-box">
                        <option value="gamer">ゲーマー向け</option>
                        <option value="high-level">ハイレベル</option>
                        <option value="enjoy">エンジョイ</option>
                        <option value="kid">子供向け</option>
                    </select>
                </div>

                <!-- ランク選択 -->
                <div class="select-container">
                    <label for="playerRank" class="select-label">あなたの現在のランク</label>
                    <select id="playerRank" class="select-box">
                        <option value="Bronze">ブロンズ</option>
                        <option value="Silver">シルバー</option>
                        <option value="Gold">ゴールド</option>
                        <option value="Platinum">プラチナ</option>
                        <option value="Diamond">ダイヤ</option>
                        <option value="Master">マスター</option>
                    </select>
                </div>

                <div class="flex flex-col mb-6">
                    <label for="freeText" class="slider-label">今日の気づき・課題・具体例（任意）</label>
                    <textarea id="freeText" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200" placeholder="例：相手の飛びに全く反応できませんでした。"></textarea>
                </div>

                <button id="diagnoseBtn" class="btn btn-primary w-full">診断する</button>
            </div>
        </section>

        <!-- 結果表示セクション (最初は非表示) -->
        <section id="results-section" class="hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">診断結果</h2>
            <p class="text-center text-gray-600 mb-6">あなたの【読み合いスキルレーダーチャート】とAIによるアドバイスです。</p>

            <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                <canvas id="radarChart"></canvas>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">AIアドバイス</h3>
                <div id="advice-output" class="p-4 bg-blue-50 border border-blue-200 rounded-md text-gray-700 leading-relaxed min-h-[100px] flex items-center justify-center">
                    <div class="loading-spinner hidden"></div>
                    <p id="advice-text">診断結果に基づいてAIがアドバイスを生成します...</p>
                </div>
            </div>

            <div class="flex justify-center space-x-4">
                <button id="shareBtn" class="btn btn-share">結果をシェア</button>
                <button id="goBackBtn" class="btn btn-secondary">戻る</button>
            </div>
        </section>

        <!-- カスタムメッセージボックス (alert() の代替) -->
        <div id="message-box" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
                <h3 id="message-title" class="text-lg font-semibold text-gray-800 mb-3"></h3>
                <p id="message-content" class="text-gray-600 mb-4"></p>
                <button id="message-ok-btn" class="btn btn-primary w-full">OK</button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数（Canvas環境から提供される場合がある）
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM要素の取得
        const formSection = document.getElementById('form-section');
        const resultsSection = document.getElementById('results-section');
        const diagnoseBtn = document.getElementById('diagnoseBtn');
        const shareBtn = document.getElementById('shareBtn');
        const goBackBtn = document.getElementById('goBackBtn');
        const radarChartCanvas = document.getElementById('radarChart');
        const adviceOutput = document.getElementById('advice-output');
        const adviceText = document.getElementById('advice-text');
        const loadingSpinner = adviceOutput.querySelector('.loading-spinner');
        const freeText = document.getElementById('freeText');
        const adviceLevelSelect = document.getElementById('adviceLevel');
        const playerRankSelect = document.getElementById('playerRank'); // 新しく追加

        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        const messageOkBtn = document.getElementById('message-ok-btn');

        let myRadarChart; // Chart.jsインスタンスを保持する変数

        // スライダーとスコア表示のペア
        const sliders = [
            { id: 'patternRecognition', display: 'patternRecognitionScore' },
            { id: 'prediction', display: 'predictionScore' },
            { id: 'reactionSpeed', display: 'reactionSpeedScore' },
            { id: 'multiLayerReading', display: 'multiLayerReadingScore' },
            { id: 'diversityOfOptions', display: 'diversityOfOptionsScore' },
            { id: 'mentalResilience', display: 'mentalResilienceScore' }
        ];

        // 各スライダーにイベントリスナーを追加
        sliders.forEach(s => {
            const slider = document.getElementById(s.id);
            const display = document.getElementById(s.display);
            slider.addEventListener('input', () => {
                display.textContent = `${slider.value}点`;
            });
        });

        // カスタムメッセージボックス表示関数
        function showMessageBox(title, content) {
            messageTitle.textContent = title;
            messageContent.textContent = content;
            messageBox.classList.remove('hidden');
        }

        // カスタムメッセージボックス非表示関数
        messageOkBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // セクション表示/非表示ヘルパー関数
        function showElement(element) {
            element.classList.remove('hidden');
        }

        function hideElement(element) {
            element.classList.add('hidden');
        }

        /**
         * レーダーチャートを生成します。
         * @param {object} scores - スキルスコアのオブジェクト
         */
        function createRadarChart(scores) {
            const ctx = radarChartCanvas.getContext('2d');

            // 既存のチャートがあれば破棄
            if (myRadarChart) {
                myRadarChart.destroy();
            }

            myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [
                        'パターン認識力',
                        '予測力',
                        '反応速度',
                        '多重読み',
                        '選択肢多様性',
                        'メンタル耐性'
                    ],
                    datasets: [{
                        label: 'あなたの読み合いスキル',
                        data: [
                            scores.patternRecognition,
                            scores.prediction,
                            scores.reactionSpeed,
                            scores.multiLayerReading,
                            scores.diversityOfOptions,
                            scores.mentalResilience
                        ],
                        backgroundColor: 'rgba(16, 185, 129, 0.4)', // Green with transparency
                        borderColor: '#10b981', // Green
                        borderWidth: 2,
                        pointBackgroundColor: '#059669', // Darker green
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#059669'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, // アスペクト比を維持
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)'
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    color: '#374151' // Dark gray for labels
                                }
                            },
                            suggestedMin: 1, // 10段階評価なので最小値を1に
                            suggestedMax: 10, // 10段階評価なので最大値を10に
                            ticks: {
                                beginAtZero: false, // 最小値が1なのでfalse
                                stepSize: 1, // 1点刻み
                                color: '#6b7280', // Medium gray for ticks
                                backdropColor: 'rgba(255, 255, 255, 0.8)' // 背景色を少し透明に
                            },
                            // レーダーの背景色
                            backgroundColor: 'rgba(249, 250, 251, 0.7)'
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // 凡例を非表示
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + '点';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Netlify Functionを呼び出してAIアドバイスを生成します。
         * @param {object} scores - スキルスコアのオブジェクト
         * @param {string} selectedAdviceLevel - 選択されたアドバイスレベル
         * @param {string} selectedPlayerRank - 選択されたプレイヤーランク
         */
        async function generateAdvice(scores, selectedAdviceLevel, selectedPlayerRank) {
            adviceText.textContent = ''; // Clear previous text
            showElement(loadingSpinner); // Show loading spinner
            adviceOutput.classList.remove('flex', 'items-center', 'justify-center'); // Remove centering for text flow

            // Netlify Functionに送るデータにランク情報を追加
            const requestBody = {
                scores: scores,
                adviceLevel: selectedAdviceLevel,
                playerRank: selectedPlayerRank // 新しく追加
            };

            const apiUrl = '/.netlify/functions/generate-advice'; // Netlify Functionのエンドポイント

            let retryCount = 0;
            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody) // サーバーにデータを送る
                    });

                    if (response.status === 429) { // Too Many Requests
                        const delay = baseDelay * Math.pow(2, retryCount);
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retryCount++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.advice) { // Netlify Functionからのレスポンスは { advice: "..." }
                        adviceText.innerHTML = result.advice.replace(/\n/g, '<br>'); // 改行を<br>タグに変換
                    } else {
                        adviceText.textContent = "AIアドバイスの生成に失敗しました。";
                        console.error("Unexpected API response structure:", result);
                    }
                    break; // Success, exit loop
                } catch (error) {
                    console.error("Error generating AI advice:", error);
                    if (retryCount < maxRetries - 1) {
                        const delay = baseDelay * Math.pow(2, retryCount);
                        console.warn(`Fetch failed. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retryCount++;
                    } else {
                        adviceText.textContent = "AIアドバイスの生成中にエラーが発生しました。時間をおいて再度お試しください。";
                    }
                }
            }
            hideElement(loadingSpinner); // Hide loading spinner
        }

        // 診断ボタンクリックイベント
        diagnoseBtn.addEventListener('click', () => {
            const scores = {
                patternRecognition: parseInt(document.getElementById('patternRecognition').value),
                prediction: parseInt(document.getElementById('prediction').value),
                reactionSpeed: parseInt(document.getElementById('reactionSpeed').value),
                multiLayerReading: parseInt(document.getElementById('multiLayerReading').value),
                diversityOfOptions: parseInt(document.getElementById('diversityOfOptions').value),
                mentalResilience: parseInt(document.getElementById('mentalResilience').value)
            };
            const selectedAdviceLevel = adviceLevelSelect.value;
            const selectedPlayerRank = playerRankSelect.value; // ランクの選択値を取得

            hideElement(formSection);
            showElement(resultsSection);

            createRadarChart(scores);
            generateAdvice(scores, selectedAdviceLevel, selectedPlayerRank); // ランクを渡す
        });

        // 戻るボタンクリックイベント
        goBackBtn.addEventListener('click', () => {
            hideElement(resultsSection);
            showElement(formSection);
            adviceText.textContent = '診断結果に基づいてAIがアドバイスを生成します...';
            adviceOutput.classList.add('flex', 'items-center', 'justify-center'); // Reset centering
        });

        // シェアボタンクリックイベント
        shareBtn.addEventListener('click', () => {
            showMessageBox(
                '結果をシェア',
                'レーダーチャート画像をスクリーンショットし、Discordなどに投稿してください！'
            );
        });

        // 初期表示時にすべてのスライダーのスコアを更新
        window.onload = function() {
            sliders.forEach(s => {
                const slider = document.getElementById(s.id);
                const display = document.getElementById(s.display);
                display.textContent = `${slider.value}点`;
            });
        };
    </script>
</body>
</html>

