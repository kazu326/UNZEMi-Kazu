<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>格ゲー読み合いスキル診断シート</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for radar chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Interフォントを適用 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }

        /* カスタムスタイル */
        .container {
            max-width: 800px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            box-sizing: border-box;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
        }

        .slider-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151; /* Dark gray text */
        }

        .slider {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: #d1d5db; /* Light gray track */
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981; /* Green thumb */
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981; /* Green thumb */
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .score-display {
            margin-left: 0.75rem;
            font-weight: 500;
            color: #4b5563; /* Medium gray text */
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #10b981; /* Green */
            color: #ffffff;
            border: none;
        }

        .btn-primary:hover {
            background-color: #059669; /* Darker green */
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #6b7280; /* Gray */
            color: #ffffff;
            border: none;
        }

        .btn-secondary:hover {
            background-color: #4b5563; /* Darker gray */
            transform: translateY(-1px);
        }

        .btn-share {
            background-color: #3b82f6; /* Blue */
            color: #ffffff;
            border: none;
        }

        .btn-share:hover {
            background-color: #2563eb; /* Darker blue */
            transform: translateY(-1px);
        }

        .btn-history {
            background-color: #f97316; /* Orange */
            color: #ffffff;
            border: none;
        }

        .btn-history:hover {
            background-color: #ea580c; /* Darker orange */
            transform: translateY(-1px);
        }

        .hidden {
            display: none;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #10b981;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        canvas {
            max-width: 100%; /* Ensure canvas scales on smaller screens */
            height: auto; /* Maintain aspect ratio */
        }

        .select-container {
            margin-bottom: 1.5rem;
        }

        .select-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .select-box {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #ffffff;
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="container">
        <!-- フォーム基本仕様イメージ -->
        <section id="form-section">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">格ゲー読み合いスキル診断シート</h1>
            <p class="text-center text-gray-600 mb-8">
                あなたの“読み合いスキル”を6つの観点で自己評価し、レーダーチャートで強みや課題を可視化するための診断フォームです。<br>
                1試合、または直近の対戦内容をもとに、各項目を**1点（全くできない）〜10点（常にできる）**で自己評価してください。
            </p>

            <div class="space-y-6">
                <!-- 設問項目・具体例（6軸バージョン） -->
                <div class="slider-group">
                    <div class="slider-container">
                        <label for="patternRecognition" class="slider-label">1. パターン認識力
                            <span class="text-sm text-gray-500 block">
                                (相手のクセ・動き・パターンに、何回目の対戦で気づけますか？)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 相手の「飛び」や「突進技」が何度もヒットするまで気づけない。ドライブゲージやスーパーアーツゲージの相手の残量もあまり見ていない。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 相手の「基本的な飛びや投げの癖」には気づくことがあるが、対応が安定しない。ドライブインパクトを返せるようになるが、完璧ではない。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 相手の「セットプレイ」「起き攻めのパターン」「特定の状況での行動選択（例：遅らせグラップ、無敵技の重ね）」を見抜ける場面が増える。相手のゲージ管理を見て、OD技やSAの有無を意識できる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** 相手の微細な行動パターン、意識配分、キャラクター固有のフレーム消費の癖まで素早く認識し、それに応じた完璧な対応や戦略変更ができる。相手の読みの読みまで意識した行動を選択できる。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="patternRecognition" min="1" max="10" value="5" class="slider">
                            <span id="patternRecognitionScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="prediction" class="slider-label">2. 予測力（先読み反応）
                            <span class="text-sm text-gray-500 block">
                                (相手の攻撃・行動をどのくらいの頻度で“先回り”できましたか？ 例：飛び・突進・攻撃タイミングを先読みで刺した回数)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 相手の行動を予測する意識が低く、常に後手になっている。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 読みを試みるが、成功率は低い。読みが当たっても次の行動に繋げられないことがある。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 相手の主要な行動（例：飛び込み、置き技、投げ）を先読みし、有利な反撃や差し返しを成功させられる。モダン操作であればアシストコンボを狙える。</li>
                                    <li>**9-10点 (上級者〜プロ級):** 相手の行動パターンと心理を深く読み解き、複数択の中から最も効果的な先読み行動（例：ドライブインパクト返し、パリィ、投げ抜け、大ダメージコンボ）を高い精度で実行できる。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="prediction" min="1" max="10" value="5" class="slider">
                            <span id="predictionScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="reactionSpeed" class="slider-label">3. 反応速度・最適対応力
                            <span class="text-sm text-gray-500 block">
                                (見てからの差し返しや対空への成功体感率は？)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 相手の確定反撃や対空攻撃をほとんど防げない。咄嗟の状況判断が遅れる。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 半分程度は見てから対応できるが、安定しない。特に画面端や状況が複雑な場面でのミスが多い。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 相手の特定の技や行動（例：ドライブインパクト、ドライブラッシュ、ジャンプ攻撃）を見てからの対応（差し返し、対空、投げ抜け）を高い精度で成功させられる。クラシック操作であれば確定反撃コンボを入れられる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** どんな状況でも相手の行動を見てから最速で最適な反撃や防御行動（例：パニッシュカウンター、大ダメージコンボ、完璧な対空コンボ）を安定して実行できる。入力精度も極めて高い。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="reactionSpeed" min="1" max="10" value="5" class="slider">
                            <span id="reactionSpeedScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="multiLayerReading" class="slider-label">4. 多重読み・心理戦
                            <span class="text-sm text-gray-500 block">
                                (「相手に読まれることを更に読んで駆け引きが出来ましたか？」)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 自分の行動が相手に読まれていることに気づきにくく、同じパターンを繰り返してしまう。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 相手が何をしようとしているかを意識し始めるが、その裏をかく行動はまだ難しい。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 相手が自分の行動をどう読んでいるかを推測し、その裏をかく行動（例：ドライブインパクトのフェイント、投げのシミー、遅らせ投げ、無敵技のガード、ドライブラッシュのキャンセル）を狙って成功させられる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** 相手の心理を深く読み解き、複数回の読み合いを連続で制する高度な心理戦（例：読みの読み、リソース管理、相手のSAゲージ消費を誘う立ち回り）を展開できる。相手を手のひらで転がすような感覚がある。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="multiLayerReading" min="1" max="10" value="5" class="slider">
                            <span id="multiLayerReadingScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="diversityOfOptions" class="slider-label">5. 選択肢の多様性・柔軟性
                            <span class="text-sm text-gray-500 block">
                                (その対戦で使えた選択肢（攻撃/守り/行動）は多かったですか？)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 使える技や戦術が少なく、同じ攻めや守りを繰り返してしまう。キャラの基本技しか使えない。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** ある程度の選択肢は持っているが、状況に合わせた最適な選択ができない。立ち回りがパターン化しやすい。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** 状況に応じて豊富な選択肢（例：様々な距離での牽制、崩し、防御オプション、リソース運用）を使い分け、相手の対策を困難にさせられる。キャラの強みを引き出せる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** 自分のキャラクターの全アセットを最大限に活用し、どんな状況でも相手の弱点や行動を潰すための最適な選択肢を柔軟に選び、ゲームを支配できる。キャラ対策も深い。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="diversityOfOptions" min="1" max="10" value="5" class="slider">
                            <span id="diversityOfOptionsScore" class="score-display">5点</span>
                        </div>
                    </div>

                    <div class="slider-container">
                        <label for="mentalResilience" class="slider-label">6. メンタル耐性・動揺度
                            <span class="text-sm text-gray-500 block">
                                (予想外の展開や連続失敗でも落ち着いて判断行動できましたか？)
                                <br>参考：
                                <ul class="list-disc list-inside ml-4 text-xs">
                                    <li>**1-2点 (初心者レベル):** 予想外のダメージや連続ヒットでパニックになり、冷静な判断ができない。逆ギレ行動や適当な技を振ってしまう。</li>
                                    <li>**3-5点 (初級者〜中級者レベル):** 不利な状況でも立て直そうとするが、まだ感情に左右されやすい。緊張で入力ミスが増えることがある。</li>
                                    <li>**6-8点 (中級者〜上級者レベル):** どんなに不利な状況やミスが続いても、感情的にならず、冷静に状況を判断し、最善の行動（例：防御重視、体力リード時の逃げ切り、ゲージ温存）を選択できる。</li>
                                    <li>**9-10点 (上級者〜プロ級):** プレッシャーのかかる場面や、相手が格上でも常に冷静沈着。ミスを即座に分析し、次のラウンドに活かせる。相手の精神を揺さぶるような行動も意図的にできる。</li>
                                </ul>
                            </span>
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="mentalResilience" min="1" max="10" value="5" class="slider">
                            <span id="mentalResilienceScore" class="score-display">5点</span>
                        </div>
                    </div>
                </div>

                <!-- AIアドバイスレベル選択 -->
                <div class="select-container">
                    <label for="adviceLevel" class="select-label">AIアドバイスレベル</label>
                    <select id="adviceLevel" class="select-box">
                        <option value="gamer">ゲーマー向け</option>
                        <option value="high-level">ハイレベル</option>
                        <option value="enjoy">エンジョイ</option>
                        <option value="kid">子供向け</option>
                    </select>
                </div>

                <!-- ランク選択 -->
                <div class="select-container">
                    <label for="playerRank" class="select-label">あなたの現在のランク</label>
                    <select id="playerRank" class="select-box">
                        <option value="Bronze">ブロンズ</option>
                        <option value="Silver">シルバー</option>
                        <option value="Gold">ゴールド</option>
                        <option value="Platinum">プラチナ</option>
                        <option value="Diamond">ダイヤ</option>
                        <option value="Master">マスター</option>
                    </select>
                </div>

                <div class="flex flex-col mb-6">
                    <label for="freeText" class="slider-label">今日の気づき・課題・具体例（任意）<span class="text-xs text-gray-500 block">(AIがこの内容も踏まえてアドバイスをくれます！)</span></label>
                    <textarea id="freeText" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200" placeholder="例：相手の飛びに全く反応できませんでした。ドライブラッシュからの攻めに対応できませんでした。"></textarea>
                </div>

                <button id="diagnoseBtn" class="btn btn-primary w-full">診断する</button>
                <button id="viewHistoryBtn" class="btn btn-history w-full mt-4">診断履歴を見る</button>
            </div>
        </section>

        <!-- 結果表示セクション (最初は非表示) -->
        <section id="results-section" class="hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">診断結果</h2>
            <p class="text-center text-gray-600 mb-6">あなたの【読み合いスキルレーダーチャート】とAIによるアドバイスです。</p>

            <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                <canvas id="radarChart"></canvas>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">AIアドバイス</h3>
                <div id="advice-output" class="p-4 bg-blue-50 border border-blue-200 rounded-md text-gray-700 leading-relaxed min-h-[100px] flex items-center justify-center">
                    <div class="loading-spinner hidden"></div>
                    <p id="advice-text">診断結果に基づいてAIがアドバイスを生成します...</p>
                </div>
            </div>

            <div class="flex justify-center space-x-4">
                <button id="saveResultBtn" class="btn btn-primary">診断結果を保存</button>
                <button id="goBackBtn" class="btn btn-secondary">戻る</button>
            </div>
        </section>

        <!-- 診断履歴セクション (最初は非表示) -->
        <section id="history-section" class="hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">診断履歴</h2>
            <p class="text-center text-gray-600 mb-6" id="history-loading-text">履歴を読み込んでいます...</p>
            <div id="history-list" class="space-y-6">
                <!-- 履歴アイテムがここに動的に追加される -->
            </div>
            <div class="flex justify-center space-x-4 mt-8">
                <button id="backToFormFromHistoryBtn" class="btn btn-secondary">診断フォームに戻る</button>
            </div>
        </section>

        <!-- カスタムメッセージボックス (alert() の代替) -->
        <div id="message-box" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
                <h3 id="message-title" class="text-lg font-semibold text-gray-800 mb-3"></h3>
                <p id="message-content" class="text-gray-600 mb-4"></p>
                <button id="message-ok-btn" class="btn btn-primary w-full">OK</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKの読み込み -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase設定は、Firebase Consoleのプロジェクト設定で確認できます
        // プロジェクト設定 > 一般 > マイアプリ > SDK のセットアップと構成 > CDN をクリックすると表示されるconfig
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // ここを置き換える
            authDomain: "YOUR_AUTH_DOMAIN", // ここを置き換える
            projectId: "YOUR_PROJECT_ID", // ここを置き換える
            storageBucket: "YOUR_STORAGE_BUCKET", // ここを置き換える
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // ここを置き換える
            appId: "YOUR_APP_ID", // ここを置き換える
            // measurementId: "G-XXXXXXXXXX" // 必要であればこの行も追加
        };

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let isAuthReady = false; // 認証準備完了フラグ

        // 認証状態の変化を監視
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ユーザーがログイン済みの場合（匿名ユーザー含む）
                currentUserId = user.uid;
                console.log("Firebase user ID:", currentUserId);
            } else {
                // ユーザーがログインしていない場合、匿名でサインイン
                try {
                    const anonymousUser = await signInAnonymously(auth);
                    currentUserId = anonymousUser.user.uid;
                    console.log("Signed in anonymously. User ID:", currentUserId);
                } catch (error) {
                    console.error("Error signing in anonymously:", error);
                    showMessageBox('エラー', '匿名認証に失敗しました。履歴保存機能が利用できません。');
                }
            }
            isAuthReady = true; // 認証準備完了
            // 認証後に履歴表示ボタンを有効にする (または初期状態で有効にしておく)
            // このアプリでは、認証が完了するまで履歴ボタンは無効にしない方がユーザー体験が良い
            // document.getElementById('viewHistoryBtn').disabled = false;
        });

        // 診断結果をFirestoreに保存する関数
        window.saveResultToFirestore = async function(resultData) {
            if (!isAuthReady || !currentUserId) {
                showMessageBox('保存エラー', 'ユーザー認証が完了していません。しばらく待ってから再度お試しください。');
                return;
            }

            try {
                // ドキュメントIDとしてタイムスタンプを使用（ユニーク性を確保）
                // Firestoreのパス: /artifacts/{appId}/users/{userId}/diagnosis_history/{docId}
                const historyRef = collection(db, `artifacts/${appId}/users/${currentUserId}/diagnosis_history`);

                await addDoc(historyRef, {
                    ...resultData,
                    timestamp: new Date() // 保存日時
                });
                showMessageBox('保存完了', '診断結果が履歴に保存されました！');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessageBox('保存エラー', '診断結果の保存に失敗しました。詳細: ' + e.message);
            }
        };

        // 診断履歴をFirestoreから読み込む関数
        window.loadHistoryFromFirestore = async function() {
            if (!isAuthReady || !currentUserId) {
                document.getElementById('history-loading-text').textContent = '履歴を読み込むには認証が必要です。';
                return;
            }

            const historyListDiv = document.getElementById('history-list');
            historyListDiv.innerHTML = ''; // 既存の履歴をクリア
            document.getElementById('history-loading-text').classList.remove('hidden'); // ロードテキストを再表示
            document.getElementById('history-loading-text').textContent = '履歴を読み込んでいます...';

            try {
                // Firestoreのパス: /artifacts/{appId}/users/{userId}/diagnosis_history
                const historyRef = collection(db, `artifacts/${appId}/users/${currentUserId}/diagnosis_history`);
                // FirestoreのorderByには制限があるため、ここでは取得後にJavaScriptでソートします
                const q = query(historyRef); // ここではorderByは使用しない

                const querySnapshot = await getDocs(q);

                let historyItems = [];
                querySnapshot.forEach((doc) => {
                    historyItems.push({ id: doc.id, ...doc.data() });
                });

                // タイムスタンプで降順ソート（新しいものが上に来るように）
                historyItems.sort((a, b) => {
                    const dateA = a.timestamp && typeof a.timestamp.toDate === 'function' ? a.timestamp.toDate() : new Date(0);
                    const dateB = b.timestamp && typeof b.timestamp.toDate === 'function' ? b.timestamp.toDate() : new Date(0);
                    return dateB - dateA;
                });

                if (historyItems.length === 0) {
                    document.getElementById('history-loading-text').textContent = 'まだ診断履歴はありません。';
                } else {
                    document.getElementById('history-loading-text').classList.add('hidden'); // ロードテキストを非表示
                }

                historyItems.forEach(item => {
                    const date = item.timestamp && typeof item.timestamp.toDate === 'function' ? item.timestamp.toDate().toLocaleString('ja-JP') : '日付不明';
                    const scores = item.scores || {};
                    const advice = item.advice || 'AIアドバイスがありません。';
                    const playerRank = item.playerRank || '不明';
                    const adviceLevel = item.adviceLevel || '不明';
                    const userFreeText = item.userFreeText || '';


                    const historyItemDiv = document.createElement('div');
                    historyItemDiv.className = 'p-4 bg-white rounded-lg shadow';
                    historyItemDiv.innerHTML = `
                        <p class="text-sm text-gray-500 mb-2">診断日時: ${date}</p>
                        <h4 class="font-semibold text-gray-700 mb-2">評価スコア:</h4>
                        <ul class="list-disc list-inside ml-4 text-sm text-gray-600">
                            <li>パターン認識力: ${scores.patternRecognition || 'N/A'}点</li>
                            <li>予測力: ${scores.prediction || 'N/A'}点</li>
                            <li>反応速度: ${scores.reactionSpeed || 'N/A'}点</li>
                            <li>多重読み: ${scores.multiLayerReading || 'N/A'}点</li>
                            <li>選択肢多様性: ${scores.diversityOfOptions || 'N/A'}点</li>
                            <li>メンタル耐性: ${scores.mentalResilience || 'N/A'}点</li>
                        </ul>
                        <h4 class="font-semibold text-gray-700 mt-4 mb-2">AIアドバイス:</h4>
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-3 text-sm text-gray-700 whitespace-pre-wrap">${advice.replace(/\n/g, '<br>')}</div>
                        <p class="text-xs text-gray-500 mt-2">ランク: ${playerRank}, アドバイスレベル: ${adviceLevel}</p>
                        ${userFreeText ? `<p class="text-xs text-gray-500 mt-2">気づき・課題: ${userFreeText}</p>` : ''}
                    `;
                    historyListDiv.appendChild(historyItemDiv);
                });
            } catch (e) {
                console.error("Error loading documents: ", e);
                document.getElementById('history-loading-text').textContent = '履歴の読み込みに失敗しました。';
                showMessageBox('履歴読み込みエラー', '履歴の読み込み中にエラーが発生しました。詳細: ' + e.message);
            }
        };
    </script>

    <script>
        // DOM要素の取得
        const formSection = document.getElementById('form-section');
        const resultsSection = document.getElementById('results-section');
        const historySection = document.getElementById('history-section'); // 新しく追加
        const diagnoseBtn = document.getElementById('diagnoseBtn');
        const saveResultBtn = document.getElementById('saveResultBtn'); // 新しく追加
        const shareBtn = document.getElementById('shareBtn');
        const goBackBtn = document.getElementById('goBackBtn');
        const viewHistoryBtn = document.getElementById('viewHistoryBtn'); // 新しく追加
        const backToFormFromHistoryBtn = document.getElementById('backToFormFromHistoryBtn'); // 新しく追加
        const radarChartCanvas = document.getElementById('radarChart');
        const adviceOutput = document.getElementById('advice-output');
        const adviceText = document.getElementById('advice-text');
        const loadingSpinner = adviceOutput.querySelector('.loading-spinner');
        const freeText = document.getElementById('freeText');
        const adviceLevelSelect = document.getElementById('adviceLevel');
        const playerRankSelect = document.getElementById('playerRank');

        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        const messageOkBtn = document.getElementById('message-ok-btn');

        let myRadarChart; // Chart.jsインスタンスを保持する変数
        let lastResultData = null; // 最新の診断結果を保存用

        // スライダーとスコア表示のペア
        const sliders = [
            { id: 'patternRecognition', display: 'patternRecognitionScore' },
            { id: 'prediction', display: 'predictionScore' },
            { id: 'reactionSpeed', display: 'reactionSpeedScore' },
            { id: 'multiLayerReading', display: 'multiLayerReadingScore' },
            { id: 'diversityOfOptions', display: 'diversityOfOptionsScore' },
            { id: 'mentalResilience', display: 'mentalResilienceScore' }
        ];

        // 各スライダーにイベントリスナーを追加
        sliders.forEach(s => {
            const slider = document.getElementById(s.id);
            const display = document.getElementById(s.display);
            slider.addEventListener('input', () => {
                display.textContent = `${slider.value}点`;
            });
        });

        // カスタムメッセージボックス表示関数
        function showMessageBox(title, content) {
            messageTitle.textContent = title;
            messageContent.textContent = content;
            messageBox.classList.remove('hidden');
        }

        // カスタムメッセージボックス非表示関数
        messageOkBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // セクション表示/非表示ヘルパー関数
        function showElement(element) {
            element.classList.remove('hidden');
        }

        function hideElement(element) {
            element.classList.add('hidden');
        }

        /**
         * レーダーチャートを生成します。
         * @param {object} scores - スキルスコアのオブジェクト
         */
        function createRadarChart(scores) {
            const ctx = radarChartCanvas.getContext('2d');

            // 既存のチャートがあれば破棄
            if (myRadarChart) {
                myRadarChart.destroy();
            }

            myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [
                        'パターン認識力',
                        '予測力',
                        '反応速度',
                        '多重読み',
                        '選択肢多様性',
                        'メンタル耐性'
                    ],
                    datasets: [{
                        label: 'あなたの読み合いスキル',
                        data: [
                            scores.patternRecognition,
                            scores.prediction,
                            scores.reactionSpeed,
                            scores.multiLayerReading,
                            scores.diversityOfOptions,
                            scores.mentalResilience
                        ],
                        backgroundColor: 'rgba(16, 185, 129, 0.4)', // Green with transparency
                        borderColor: '#10b981', // Green
                        borderWidth: 2,
                        pointBackgroundColor: '#059669', // Darker green
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#059669'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, // アスペクト比を維持
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)'
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    color: '#374151' // Dark gray for labels
                                }
                            },
                            suggestedMin: 1, // 10段階評価なので最小値を1に
                            suggestedMax: 10, // 10段階評価なので最大値を10に
                            ticks: {
                                beginAtZero: false, // 最小値が1なのでfalse
                                stepSize: 1, // 1点刻み
                                color: '#6b7280', // Medium gray for ticks
                                backdropColor: 'rgba(255, 255, 255, 0.8)' // 背景色を少し透明に
                            },
                            // レーダーの背景色
                            backgroundColor: 'rgba(249, 250, 251, 0.7)'
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // 凡例を非表示
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + '点';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Netlify Functionを呼び出してAIアドバイスを生成します。
         * @param {object} scores - スキルスコアのオブジェクト
         * @param {string} selectedAdviceLevel - 選択されたアドバイスレベル
         * @param {string} selectedPlayerRank - 選択されたプレイヤーランク
         * @param {string} userFreeText - ユーザーが入力した自由記述の気づきや課題
         */
        async function generateAdvice(scores, selectedAdviceLevel, selectedPlayerRank, userFreeText) {
            adviceText.textContent = ''; // Clear previous text
            showElement(loadingSpinner); // Show loading spinner
            adviceOutput.classList.remove('flex', 'items-center', 'justify-center'); // Remove centering for text flow

            // Netlify Functionに送るデータにランク情報と自由記述を追加
            const requestBody = {
                scores: scores,
                adviceLevel: selectedAdviceLevel,
                playerRank: selectedPlayerRank,
                userFreeText: userFreeText
            };

            const apiUrl = '/.netlify/functions/generate-advice'; // Netlify Functionのエンドポイント

            let generatedAdvice = "AIアドバイスの生成に失敗しました。"; // デフォルト値

            let retryCount = 0;
            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody) // サーバーにデータを送る
                    });

                    if (response.status === 429) { // Too Many Requests
                        const delay = baseDelay * Math.pow(2, retryCount);
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retryCount++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.advice) { // Netlify Functionからのレスポンスは { advice: "..." }
                        generatedAdvice = result.advice;
                        adviceText.innerHTML = generatedAdvice.replace(/\n/g, '<br>'); // 改行を<br>タグに変換
                    } else {
                        console.error("Unexpected API response structure:", result);
                    }
                    break; // Success, exit loop
                } catch (error) {
                    console.error("Error generating AI advice:", error);
                    if (retryCount < maxRetries - 1) {
                        const delay = baseDelay * Math.pow(2, retryCount);
                        console.warn(`Fetch failed. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retryCount++;
                    } else {
                        adviceText.textContent = "AIアドバイスの生成中にエラーが発生しました。時間をおいて再度お試しください。";
                    }
                }
            }
            hideElement(loadingSpinner); // Hide loading spinner

            // 診断結果を保存用に格納
            lastResultData = {
                scores: scores,
                advice: generatedAdvice, // 生成されたアドバイスを保存
                adviceLevel: selectedAdviceLevel,
                playerRank: selectedPlayerRank,
                userFreeText: userFreeText
            };
        }

        // 診断ボタンクリックイベント
        diagnoseBtn.addEventListener('click', () => {
            const scores = {
                patternRecognition: parseInt(document.getElementById('patternRecognition').value),
                prediction: parseInt(document.getElementById('prediction').value),
                reactionSpeed: parseInt(document.getElementById('reactionSpeed').value),
                multiLayerReading: parseInt(document.getElementById('multiLayerReading').value),
                diversityOfOptions: parseInt(document.getElementById('diversityOfOptions').value),
                mentalResilience: parseInt(document.getElementById('mentalResilience').value)
            };
            const selectedAdviceLevel = adviceLevelSelect.value;
            const selectedPlayerRank = playerRankSelect.value;
            const userFreeText = freeText.value;

            hideElement(formSection);
            showElement(resultsSection);
            hideElement(historySection); // 履歴表示中に診断した場合に備えて非表示

            createRadarChart(scores);
            generateAdvice(scores, selectedAdviceLevel, selectedPlayerRank, userFreeText);
        });

        // 診断結果保存ボタンクリックイベント
        saveResultBtn.addEventListener('click', () => {
            if (lastResultData) {
                // saveResultToFirestoreはFirebase SDKのscriptタグ内で定義されるグローバル関数
                window.saveResultToFirestore(lastResultData);
            } else {
                showMessageBox('保存エラー', '保存する診断結果がありません。まず診断を実行してください。');
            }
        });

        // 診断結果画面から戻るボタンクリックイベント
        goBackBtn.addEventListener('click', () => {
            hideElement(resultsSection);
            showElement(formSection);
            adviceText.textContent = '診断結果に基づいてAIがアドバイスを生成します...';
            adviceOutput.classList.add('flex', 'items-center', 'justify-center'); // Reset centering
        });

        // 診断履歴を見るボタンクリックイベント
        viewHistoryBtn.addEventListener('click', async () => {
            hideElement(formSection);
            hideElement(resultsSection);
            showElement(historySection);
            // 履歴を読み込む関数を呼び出す
            await window.loadHistoryFromFirestore();
        });

        // 診断履歴画面から診断フォームに戻るボタンクリックイベント
        backToFormFromHistoryBtn.addEventListener('click', () => {
            hideElement(historySection);
            showElement(formSection);
            // ロード中のテキストを元に戻す
            document.getElementById('history-loading-text').classList.remove('hidden');
            document.getElementById('history-loading-text').textContent = '履歴を読み込んでいます...';
        });


        // シェアボタンクリックイベント
        shareBtn.addEventListener('click', () => {
            showMessageBox(
                '結果をシェア',
                'レーダーチャート画像をスクリーンショットし、Discordなどに投稿してください！'
            );
        });

        // 初期表示時にすべてのスライダーのスコアを更新
        window.onload = function() {
            sliders.forEach(s => {
                const slider = document.getElementById(s.id);
                const display = document.getElementById(s.display);
                display.textContent = `${slider.value}点`;
            });
            // 認証完了まで履歴ボタンを無効化 (今回は自動匿名認証なので不要かもしれませんが、念のため)
            // viewHistoryBtn.disabled = true;
        };
    </script>
</body>
</html>
